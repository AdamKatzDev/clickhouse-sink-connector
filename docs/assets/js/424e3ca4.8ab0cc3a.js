"use strict";(self.webpackChunkclickhouse_sink_connector=self.webpackChunkclickhouse_sink_connector||[]).push([[4105],{3905:(e,t,r)=>{r.d(t,{Zo:()=>u,kt:()=>m});var n=r(7294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function i(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function c(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var s=n.createContext({}),l=function(e){var t=n.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):i(i({},t),e)),r},u=function(e){var t=l(e.components);return n.createElement(s.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,u=c(e,["components","mdxType","originalType","parentName"]),p=l(r),h=a,m=p["".concat(s,".").concat(h)]||p[h]||d[h]||o;return r?n.createElement(m,i(i({ref:t},u),{},{components:r})):n.createElement(m,i({ref:t},u))}));function m(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=r.length,i=new Array(o);i[0]=h;var c={};for(var s in t)hasOwnProperty.call(t,s)&&(c[s]=t[s]);c.originalType=e,c[p]="string"==typeof e?e:a,i[1]=c;for(var l=2;l<o;l++)i[l]=r[l];return n.createElement.apply(null,i)}return n.createElement.apply(null,r)}h.displayName="MDXCreateElement"},7703:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>c,toc:()=>l});var n=r(7462),a=(r(7294),r(3905));const o={},i="Architecture",c={unversionedId:"doc/architecture",id:"doc/architecture",title:"Architecture",description:"arch",source:"@site/docs/doc/architecture.md",sourceDirName:"doc",slug:"/doc/architecture",permalink:"/clickhouse-sink-connector/docs/doc/architecture",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/doc/architecture.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Troubleshooting",permalink:"/clickhouse-sink-connector/docs/doc/Troubleshooting"},next:{title:"debezium_setup",permalink:"/clickhouse-sink-connector/docs/doc/debezium_setup"}},s={},l=[{value:"DeDuplicator",id:"deduplicator",level:2},{value:"Exactly Once Semantics",id:"exactly-once-semantics",level:2}],u={toc:l},p="wrapper";function d(e){let{components:t,...o}=e;return(0,a.kt)(p,(0,n.Z)({},u,o,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"architecture"},"Architecture"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"arch",src:r(2945).Z,width:"842",height:"571"})),(0,a.kt)("h2",{id:"deduplicator"},"DeDuplicator"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Assumption"),": each table has to have a ",(0,a.kt)("strong",{parentName:"p"},"Deduplication key")," specified.\nDeduplication key is a set of fields, explicitly specified to be used as a basis for deduplication.\nIn case PK is defined it is natural to use PK as Deduplication Key as well, It is not mandatory, however, and for tables\nwithout PK, Deduplication key is still required."),(0,a.kt)("p",null,"Connector maintains a map (Deduplication Map), where the key is a Deduplication key and the value is the record itself.\nAs soon as a new record with the same Deduplication key arrives, it either replaces the existing record\nin the Deduplication Map or is dropped, based on the ",(0,a.kt)("strong",{parentName:"p"},"Deduplication Policy"),". Records from the Deduplication Map are\nformed into a Batch and are flushed into the ClickHouse on either time or size-based ",(0,a.kt)("strong",{parentName:"p"},"Dump Policy"),"."),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},(0,a.kt)("strong",{parentName:"p"},"NB")," it should be noted, that time-based batch flush can not form the same batches upon replay.")),(0,a.kt)("p",null,"Flushed rows are removed from the Deduplication Map based on either time or size-based ",(0,a.kt)("strong",{parentName:"p"},"Clear Policy")),(0,a.kt)("p",null,"As a result of the Deduplication Map application, connector has a set of records, which are de-duplicated within\na certain time or size - limited window of records."),(0,a.kt)("h2",{id:"exactly-once-semantics"},"Exactly Once Semantics"),(0,a.kt)("p",null,"Exactly once semantics are guaranteed by storing offsets(by topic, partition) in a separate\nclickhouse table. The table will be ordered by time and a materialized view will be created as a\ncache to avoid expensive table scans."),(0,a.kt)("p",null,"Topic management will be disabled in Kafka connect and the ",(0,a.kt)("inlineCode",{parentName:"p"},"precommit()")," function in\nSinkTask would return the offsets stored in clickhouse."),(0,a.kt)("p",null,"References:\n","[1]"," ",(0,a.kt)("a",{parentName:"p",href:"https://stackoverflow.com/questions/55608325/clickhouse-select-last-record-without-max-on-all-table"},"https://stackoverflow.com/questions/55608325/clickhouse-select-last-record-without-max-on-all-table")))}d.isMDXComponent=!0},2945:(e,t,r)=>{r.d(t,{Z:()=>n});const n=r.p+"assets/images/arch-915ad0cf60d167c29e61f5f1840d4db5.png"}}]);